
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Lava Pro - Gest√£o com WhatsApp</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232563eb'><path d='M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z'/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --whatsapp: #25d366; --bg: #f8fafc; }
      body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
      
      .nav-item { transition: all 0.2s; position: relative; }
      .nav-active { background-color: var(--primary) !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.25); }
      .nav-active i { color: white !important; }

      .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 24px; transition: all 0.2s; }
      
      .btn-action { border-radius: 16px; font-weight: 800; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border: none; outline: none; }
      .btn-action:active { transform: scale(0.96); }
      .btn-blue { background: var(--primary); color: white; }
      .btn-green { background: var(--success); color: white; }
      .btn-whatsapp { background: var(--whatsapp); color: white; }
      .btn-red { background: var(--danger); color: white; }
      .btn-ghost { background: #f1f5f9; color: #64748b; }

      .input-premium { width: 100%; padding: 14px 18px; background-color: #f1f5f9; border: 1.5px solid transparent; border-radius: 16px; font-weight: 700; outline: none; transition: all 0.2s; color: #1e293b; font-size: 14px; }
      .input-premium:focus { border-color: var(--primary); background-color: white; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.08); }

      .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

      .animate-in { animation: fadeIn 0.4s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .tab-btn { padding: 12px 24px; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; border-bottom: 3px solid transparent; transition: all 0.2s; }
      .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

      @media (max-width: 768px) { .hide-mobile { display: none !important; } }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
  <body class="bg-slate-50">
    
    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
      <div id="modal-box" class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden max-h-[92vh] overflow-y-auto custom-scrollbar relative"></div>
    </div>

    <div class="flex h-screen overflow-hidden">
      <aside class="w-72 bg-white border-r border-slate-200 flex flex-col hide-mobile shrink-0">
        <div class="p-8 flex items-center gap-4">
          <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i data-lucide="droplet"></i></div>
          <span class="font-black text-2xl tracking-tighter">LAVA<span class="text-blue-600">PRO</span></span>
        </div>
        <nav class="flex-1 px-4 space-y-2">
          <button onclick="navigateTo('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50"><i data-lucide="layout-dashboard"></i> Dashboard</button>
          <button onclick="navigateTo('patio')" id="nav-patio" class="nav-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50"><i data-lucide="navigation"></i> P√°tio Ativo</button>
          <button onclick="navigateTo('customers')" id="nav-customers" class="nav-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50"><i data-lucide="users"></i> Clientes</button>
          <button onclick="navigateTo('financial')" id="nav-financial" class="nav-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50"><i data-lucide="banknote"></i> Financeiro</button>
          <button onclick="navigateTo('employees')" id="nav-employees" class="nav-item w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-sm text-slate-500 hover:bg-slate-50"><i data-lucide="hard-hat"></i> Equipe</button>
        </nav>
      </aside>

      <main class="flex-1 flex flex-col overflow-hidden">
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-10 shrink-0">
          <div><h2 id="view-title" class="font-black text-slate-900 uppercase text-xs tracking-[0.2em]">DASHBOARD</h2></div>
          <div id="header-actions"></div>
        </header>
        <div id="content" class="flex-1 overflow-y-auto p-10 custom-scrollbar"></div>
      </main>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white border-t border-slate-200 flex items-center justify-around z-50 lg:hidden shadow-2xl">
      <button onclick="navigateTo('dashboard')" class="flex flex-col items-center gap-1 text-slate-400"><i data-lucide="layout-dashboard"></i><span class="text-[9px] font-black">HOME</span></button>
      <button onclick="navigateTo('patio')" class="flex flex-col items-center gap-1 text-slate-400"><i data-lucide="navigation"></i><span class="text-[9px] font-black">P√ÅTIO</span></button>
      <button onclick="navigateTo('financial')" class="flex flex-col items-center gap-1 text-slate-400"><i data-lucide="banknote"></i><span class="text-[9px] font-black">$$$</span></button>
      <button onclick="navigateTo('employees')" class="flex flex-col items-center gap-1 text-slate-400"><i data-lucide="hard-hat"></i><span class="text-[9px] font-black">TIME</span></button>
    </nav>

    <script type="module">
      const DB_NAME = 'lavapro_v2_finance';
      const DB = {
        save: (key, data) => localStorage.setItem(`${DB_NAME}_${key}`, JSON.stringify(data)),
        get: (key) => JSON.parse(localStorage.getItem(`${DB_NAME}_${key}`)) || [],
        init: () => {
          if (!localStorage.getItem(`${DB_NAME}_init`)) {
            DB.save('customers', []); DB.save('services', []); 
            DB.save('expenses', []); DB.save('employees', []);
            localStorage.setItem(`${DB_NAME}_init`, 'true');
          }
        }
      };
      DB.init();

      let currentFinancialTab = 'income';

      window.closeModal = () => {
        document.getElementById('modal-container').classList.add('hidden');
        document.getElementById('modal-container').classList.remove('flex');
      };

      // NOVO MODAL DE CONFIRMA√á√ÉO DO SISTEMA
      window.openConfirmModal = (title, message, onConfirm) => {
        const b = document.getElementById('modal-box');
        const m = document.getElementById('modal-container');
        m.classList.remove('hidden'); m.classList.add('flex');
        b.innerHTML = `
          <div class="p-10 flex flex-col items-center text-center">
            <div class="w-20 h-20 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6 shadow-sm">
              <i data-lucide="alert-triangle" class="w-10 h-10"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-900 mb-2 uppercase tracking-tighter">${title}</h3>
            <p class="text-slate-500 font-medium mb-8 leading-relaxed px-4">${message}</p>
            <div class="flex gap-4 w-full">
              <button onclick="closeModal()" class="flex-1 py-4 btn-action btn-ghost uppercase text-xs tracking-widest">Cancelar</button>
              <button id="confirm-action-btn" class="flex-1 py-4 btn-action btn-red uppercase text-xs tracking-widest shadow-lg shadow-red-100">Confirmar</button>
            </div>
          </div>
        `;
        document.getElementById('confirm-action-btn').onclick = () => {
          onConfirm();
          closeModal();
        };
        lucide.createIcons();
      };

      window.sendWA = (phone, msg) => {
        if(!phone) return alert('Telefone n√£o cadastrado!');
        const cleanPhone = phone.replace(/\D/g, '');
        const url = `https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
      };

      window.copyToClipboard = (text, btn) => {
        navigator.clipboard.writeText(text || '');
        const old = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
        lucide.createIcons();
        setTimeout(() => { btn.innerHTML = old; lucide.createIcons(); }, 1500);
      };

      window.fetchAddress = async (cep) => {
        const cleanCep = cep.replace(/\D/g, '');
        if (cleanCep.length !== 8) return;
        try {
          const res = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
          const data = await res.json();
          if (!data.erro) {
            const inputAddr = document.querySelector('[name="address"]');
            const inputNeigh = document.querySelector('[name="neighborhood"]');
            const inputCity = document.querySelector('[name="city"]');
            if(inputAddr) inputAddr.value = data.logradouro || '';
            if(inputNeigh) inputNeigh.value = data.bairro || '';
            if(inputCity) inputCity.value = `${data.localidade} - ${data.uf}`;
          }
        } catch (e) { console.error("CEP error", e); }
      };

      window.navigateTo = (vid) => {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
        const dNav = document.getElementById(`nav-${vid}`);
        if(dNav) dNav.classList.add('nav-active');
        document.getElementById('view-title').innerText = vid.toUpperCase();
        document.getElementById('content').innerHTML = views[vid] ? views[vid]() : '<h1>Erro</h1>';
        window.updateHeaderActions(vid);
        lucide.createIcons();
      };

      window.updateHeaderActions = (vid) => {
        const actions = document.getElementById('header-actions');
        actions.innerHTML = '';
        if (vid === 'patio') {
          actions.innerHTML = `<button onclick="openModal('service')" class="btn-action btn-blue px-6 py-4 text-xs uppercase tracking-widest shadow-lg shadow-blue-100"><i data-lucide="plus"></i> Nova Entrada</button>`;
        } else if (vid === 'customers') {
          actions.innerHTML = `<button onclick="openModal('customer')" class="btn-action btn-green px-6 py-4 text-xs uppercase tracking-widest shadow-lg shadow-emerald-100"><i data-lucide="user-plus"></i> Novo Cliente</button>`;
        } else if (vid === 'financial') {
          actions.innerHTML = `<button onclick="openModal('expense')" class="btn-action btn-red px-6 py-4 text-xs uppercase tracking-widest shadow-lg shadow-red-100"><i data-lucide="trending-down"></i> Lan√ßar Despesa</button>`;
        } else if (vid === 'employees') {
          actions.innerHTML = `<button onclick="openModal('employee')" class="btn-action btn-blue px-6 py-4 text-xs uppercase tracking-widest shadow-lg shadow-blue-100"><i data-lucide="plus"></i> Novo Funcion√°rio</button>`;
        }
        lucide.createIcons();
      };

      const views = {
        dashboard: () => {
          const allServices = DB.get('services');
          const paidServices = allServices.filter(s => s.paid && s.received !== false);
          const expenses = DB.get('expenses');
          const totalIncome = paidServices.reduce((a, b) => a + (Number(b.value) || 0), 0);
          const totalExpense = expenses.reduce((a, b) => a + (Number(b.value) || 0), 0);
          return `
            <div class="animate-in space-y-8">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card p-8 bg-blue-600 text-white shadow-2xl">
                  <p class="text-[10px] font-black uppercase opacity-60 tracking-widest">Saldo Real (Em Caixa)</p>
                  <h3 class="text-4xl font-black mt-2">R$ ${(totalIncome - totalExpense).toFixed(2)}</h3>
                </div>
                <div class="glass-card p-8 border-l-8 border-l-emerald-500">
                  <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Entradas Confirmadas</p>
                  <h3 class="text-3xl font-black text-slate-800 mt-2">R$ ${totalIncome.toFixed(2)}</h3>
                </div>
                <div class="glass-card p-8 border-l-8 border-l-red-500">
                  <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sa√≠das (Custos)</p>
                  <h3 class="text-3xl font-black text-slate-800 mt-2">R$ ${totalExpense.toFixed(2)}</h3>
                </div>
              </div>
              <div class="glass-card p-10 bg-slate-900 text-white flex items-center justify-between">
                <div><h4 class="font-black text-blue-400 text-xs tracking-widest uppercase">Gerenciamento de Fluxo</h4><p class="text-sm opacity-60">Controle pagamentos √† vista, prazo e conv√™nios.</p></div>
                <button onclick="navigateTo('patio')" class="px-6 py-3 bg-blue-600 rounded-xl font-bold text-xs uppercase shadow-xl">Ver P√°tio Ativo</button>
              </div>
            </div>
          `;
        },
        patio: () => {
          const services = DB.get('services').filter(s => s.status !== 'Entregue');
          return `
            <div class="animate-in grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${services.map(s => {
                const isReady = s.status === 'Pronto';
                const msgPronto = `Ol√°! O seu ve√≠culo *${s.car}* (${s.plate}) j√° est√° *PRONTO* aqui no Lava Pro! ‚ú® Pode vir buscar quando quiser.`;
                return `
                <div class="glass-card p-6 border-l-[12px] ${isReady ? 'border-l-emerald-500 bg-emerald-50/10' : (s.status === 'Em Lavagem' ? 'border-l-blue-500' : 'border-l-amber-500')}">
                  <div class="flex items-center gap-4 mb-5">
                    <div class="w-14 h-14 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-600"><i data-lucide="car"></i></div>
                    <div class="flex-1 min-w-0">
                      <h4 class="font-black uppercase text-sm truncate">${s.car}</h4>
                      <span class="bg-slate-900 text-white px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest">${s.plate}</span>
                    </div>
                    <button onclick="sendWA('${s.phone}', \`${msgPronto}\`)" class="w-12 h-12 bg-green-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-green-100 hover:scale-105 transition-all" title="Avisar que est√° pronto">
                      <i data-lucide="message-circle"></i>
                    </button>
                  </div>
                  
                  <div class="space-y-4">
                    <div class="bg-slate-100 p-4 rounded-2xl">
                       <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Status Atual</p>
                       <select onchange="updateStatus('${s.id}', this.value)" class="w-full bg-transparent text-[10px] font-black uppercase outline-none cursor-pointer">
                        <option value="Aguardando" ${s.status === 'Aguardando' ? 'selected' : ''}>‚è≥ Na Fila</option>
                        <option value="Em Lavagem" ${s.status === 'Em Lavagem' ? 'selected' : ''}>ü´ß Lavando...</option>
                        <option value="Pronto" ${s.status === 'Pronto' ? 'selected' : ''}>‚ú® Finalizado</option>
                        <option value="Entregue">üöÄ Entregue</option>
                      </select>
                    </div>

                    ${isReady ? `
                      <button onclick="openCheckoutModal('${s.id}')" class="w-full py-4 btn-action btn-green uppercase text-[10px] tracking-widest shadow-xl shadow-emerald-100 animate-pulse">
                        <i data-lucide="banknote"></i> Receber R$ ${(Number(s.value) || 0).toFixed(2)}
                      </button>
                    ` : ''}
                  </div>
                </div>
              `}).join('') || '<div class="col-span-full py-20 text-center opacity-20 font-black uppercase tracking-widest">Nenhum ve√≠culo no p√°tio</div>'}
            </div>
          `;
        },
        customers: () => {
          const custs = DB.get('customers');
          return `
            <div class="animate-in grid grid-cols-1 md:grid-cols-3 gap-6">
              ${custs.map(c => `
                <div class="glass-card p-8">
                  <div class="flex justify-between items-start mb-6">
                    <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 font-black text-xl">${c.name[0]}</div>
                    <button onclick="sendWA('${c.phone}', 'Ol√° ${c.name}, como vai? Gostaria de agendar uma lavagem conosco?')" class="bg-green-100 text-green-600 p-3 rounded-2xl hover:bg-green-500 hover:text-white transition-all shadow-sm">
                      <i data-lucide="message-circle"></i>
                    </button>
                  </div>
                  <h4 class="font-black text-slate-800 uppercase text-sm">${c.name}</h4>
                  <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-widest">${c.cpf}</p>
                  <div class="mt-6 space-y-3 pt-6 border-t flex justify-between">
                    <div>
                      <p class="text-[10px] text-slate-500 font-black uppercase flex items-center gap-2"><i data-lucide="map-pin" class="w-3 h-3"></i> ${c.address || 'Sem Endere√ßo'}</p>
                      <p class="text-[10px] text-slate-400 font-bold uppercase"><i data-lucide="hash" class="w-3 h-3 inline"></i> CEP: ${c.cep || '00000-000'}</p>
                      <p class="text-xs text-slate-600 font-black"><i data-lucide="phone" class="w-3 h-3 inline"></i> ${c.phone}</p>
                    </div>
                    <div class="flex items-end">
                       <button onclick="deleteCustomer('${c.id}')" class="text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                  </div>
                </div>
              `).join('') || '<p class="col-span-full text-center py-20 opacity-20 font-black">Nenhum cliente cadastrado.</p>'}
            </div>
          `;
        },
        financial: () => {
          const services = DB.get('services').filter(s => s.paid);
          const expenses = DB.get('expenses');
          return `
            <div class="animate-in space-y-6">
              <div class="flex border-b border-slate-200 mb-8">
                <button onclick="changeFinancialTab('income')" class="tab-btn ${currentFinancialTab === 'income' ? 'active' : ''}">Faturamento (NFe)</button>
                <button onclick="changeFinancialTab('expense')" class="tab-btn ${currentFinancialTab === 'expense' ? 'active' : ''}">Despesas</button>
              </div>
              ${currentFinancialTab === 'income' ? `
                <div class="glass-card overflow-hidden">
                  <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b">
                      <tr><th class="px-8 py-4">Data</th><th class="px-8 py-4">Status</th><th class="px-8 py-4">Cliente/Endere√ßo</th><th class="px-8 py-4">Pagamento/Prazo</th><th class="px-8 py-4 text-right">Valor</th><th class="px-8 py-4 text-right">A√ß√µes</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                      ${services.reverse().map(s => {
                        const valNum = Number(s.value) || 0;
                        const isReceived = s.received !== false;
                        const recMsg = `*Lava Pro - Comprovante*

Ol√°! Aqui est√° o resumo do seu servi√ßo:

*Ve√≠culo:* ${s.car}
*Placa:* ${s.plate}
*Valor:* R$ ${valNum.toFixed(2)}
*Data:* ${s.entryDate}
*Pagamento:* ${s.method} (${s.term})
*Obs:* ${s.obs || '-'}

_Obrigado pela prefer√™ncia!_`;
                        return `
                        <tr class="hover:bg-slate-50 transition-colors">
                          <td class="px-8 py-5 text-xs font-bold text-slate-500">${s.entryDate}</td>
                          <td class="px-8 py-5">
                            ${isReceived 
                              ? `<span class="bg-emerald-100 text-emerald-600 px-2 py-1 rounded text-[9px] font-black uppercase">PAGO</span>`
                              : `<span class="bg-amber-100 text-amber-600 px-2 py-1 rounded text-[9px] font-black uppercase">PENDENTE</span>`
                            }
                          </td>
                          <td class="px-8 py-5">
                            <p class="font-black text-xs uppercase text-slate-800">${s.car}</p>
                            <p class="text-[9px] text-slate-400 font-bold">${s.customerCpf || 'Sem CPF'}</p>
                            <p class="text-[8px] text-slate-300 font-bold uppercase truncate max-w-[140px]">${s.customerAddress || ''}</p>
                          </td>
                          <td class="px-8 py-5">
                            <p class="text-[10px] font-black text-blue-600 uppercase">${s.method || 'PIX'}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase">${s.term || '√Ä Vista'}</p>
                            ${s.obs ? `<p class="text-[8px] italic text-amber-600 font-bold mt-1">"${s.obs}"</p>` : ''}
                          </td>
                          <td class="px-8 py-5 text-right font-black text-sm">R$ ${valNum.toFixed(2)}</td>
                          <td class="px-8 py-5 text-right flex justify-end gap-1">
                            ${!isReceived ? `
                              <button onclick="markAsReceived('${s.id}')" title="Confirmar Recebimento" class="p-2 bg-blue-100 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="check-circle" class="w-4 h-4"></i></button>
                            ` : ''}
                            <button onclick="sendWA('${s.phone}', \`${recMsg}\`)" title="WhatsApp" class="p-2 bg-green-100 text-green-600 rounded-xl hover:bg-green-500 hover:text-white transition-all"><i data-lucide="send" class="w-4 h-4"></i></button>
                            <button onclick="openModal('edit_service', '${s.id}')" title="Editar" class="p-2 bg-slate-100 text-slate-400 rounded-xl hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="deleteService('${s.id}')" title="Excluir" class="p-2 bg-slate-100 text-slate-400 rounded-xl hover:bg-red-600 hover:text-white transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                          </td>
                        </tr>
                      `}).join('') || '<tr><td colspan="6" class="p-20 text-center opacity-30 font-black uppercase">Nenhuma receita registrada</td></tr>'}
                    </tbody>
                  </table>
                </div>
              ` : `
                <div class="glass-card overflow-hidden">
                  <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                      <tr><th class="px-8 py-4">Data</th><th class="px-8 py-4">Categoria</th><th class="px-8 py-4">Descri√ß√£o</th><th class="px-8 py-4 text-right">Valor</th><th class="px-8 py-4 text-right">A√ß√µes</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                      ${expenses.reverse().map(e => `
                        <tr>
                          <td class="px-8 py-5 text-xs font-bold text-slate-500">${e.date}</td>
                          <td class="px-8 py-5"><span class="bg-red-50 text-red-600 px-2.5 py-1 rounded-lg text-[9px] font-black uppercase">${e.category}</span></td>
                          <td class="px-8 py-5 text-xs font-bold text-slate-600 uppercase">${e.description}</td>
                          <td class="px-8 py-5 text-right font-black text-sm text-red-600">R$ ${(Number(e.value) || 0).toFixed(2)}</td>
                          <td class="px-8 py-5 text-right">
                            <button onclick="deleteExpense('${e.id}')" class="text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                          </td>
                        </tr>
                      `).join('') || '<tr><td colspan="5" class="p-20 text-center opacity-30 font-black uppercase">Nenhuma despesa registrada</td></tr>'}
                    </tbody>
                  </table>
                </div>
              `}
            </div>
          `;
        },
        employees: () => {
          const employees = DB.get('employees');
          return `
            <div class="animate-in grid grid-cols-1 md:grid-cols-2 gap-6">
              ${employees.map(e => {
                const totalDebt = (Number(e.advances) || 0) + (Number(e.consumption) || 0);
                const netSalary = (Number(e.salary) || 0) - totalDebt;
                return `
                  <div class="glass-card p-8">
                    <div class="flex justify-between items-start mb-6">
                      <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-black text-xl">${e.name[0]}</div>
                        <div><h4 class="font-black text-lg uppercase">${e.name}</h4><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sal√°rio: R$ ${(Number(e.salary) || 0).toFixed(2)}</p></div>
                      </div>
                      <button onclick="deleteEmployee('${e.id}')" class="text-slate-300 hover:text-red-500 transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                      <div class="bg-amber-50 p-5 rounded-3xl">
                        <p class="text-[9px] font-black text-amber-600 uppercase mb-2">Vales / Vales</p>
                        <p class="font-black text-slate-800 text-lg">R$ ${(Number(e.advances) || 0).toFixed(2)}</p>
                      </div>
                      <div class="bg-red-50 p-5 rounded-3xl">
                        <p class="text-[9px] font-black text-red-600 uppercase mb-2">Consuma√ß√£o</p>
                        <p class="font-black text-slate-800 text-lg">R$ ${(Number(e.consumption) || 0).toFixed(2)}</p>
                      </div>
                    </div>
                    <div class="pt-6 border-t flex items-center justify-between">
                      <div><p class="text-[10px] font-black text-slate-400 uppercase">Saldo Final</p><h4 class="text-2xl font-black text-emerald-600">R$ ${netSalary.toFixed(2)}</h4></div>
                      <div class="flex gap-2">
                         <button onclick="resetEmployeeDebts('${e.id}')" title="Limpar D√©bitos" class="bg-slate-100 text-slate-400 p-3 rounded-2xl hover:bg-slate-200 transition-all"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                         <button onclick="openModal('add_debt', '${e.id}')" class="bg-slate-900 text-white px-5 py-3 rounded-2xl text-[10px] font-black uppercase shadow-xl">+ D√©bito</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('') || '<p class="col-span-full py-20 text-center opacity-20 font-black uppercase">Nenhum funcion√°rio</p>'}
            </div>
          `;
        }
      };

      window.changeFinancialTab = (tab) => { currentFinancialTab = tab; window.navigateTo('financial'); };

      window.updateStatus = (id, val) => {
        const s = DB.get('services');
        const i = s.findIndex(x => String(x.id) === String(id));
        if(i !== -1) {
          if(val === 'Entregue') window.openCheckoutModal(id);
          else { s[i].status = val; DB.save('services', s); window.navigateTo('patio'); }
        }
      };

      window.markAsReceived = (id) => {
        const l = DB.get('services');
        const i = l.findIndex(x => String(x.id) === String(id));
        if(i !== -1) {
          l[i].received = true;
          DB.save('services', l);
          window.navigateTo('financial');
        }
      };

      // SUBSTITUINDO CONFIRM() POR openConfirmModal()
      window.deleteService = (id) => {
        window.openConfirmModal('Excluir Lan√ßamento', 'Deseja excluir este registro de faturamento permanentemente?', () => {
          const l = DB.get('services').filter(x => String(x.id) !== String(id));
          DB.save('services', l);
          window.navigateTo('financial');
        });
      };

      window.deleteExpense = (id) => {
        window.openConfirmModal('Excluir Despesa', 'Deseja remover esta despesa do seu financeiro?', () => {
          const l = DB.get('expenses').filter(x => String(x.id) !== String(id));
          DB.save('expenses', l);
          window.navigateTo('financial');
        });
      };

      window.deleteCustomer = (id) => {
        window.openConfirmModal('Remover Cliente', 'Isso ir√° remover o cliente e o hist√≥rico de seus ve√≠culos. Deseja continuar?', () => {
          const l = DB.get('customers').filter(x => String(x.id) !== String(id));
          DB.save('customers', l);
          window.navigateTo('customers');
        });
      };

      window.deleteEmployee = (id) => {
        window.openConfirmModal('Remover Funcion√°rio', 'Deseja desligar este colaborador do sistema?', () => {
          const l = DB.get('employees').filter(x => String(x.id) !== String(id));
          DB.save('employees', l);
          window.navigateTo('employees');
        });
      };

      window.resetEmployeeDebts = (id) => {
        window.openConfirmModal('Limpar D√©bitos', 'Isso ir√° zerar todos os vales e consuma√ß√£o do funcion√°rio (Fechamento do M√™s). Confirma?', () => {
          const l = DB.get('employees');
          const i = l.findIndex(x => String(x.id) === String(id));
          if(i !== -1) { l[i].advances = 0; l[i].consumption = 0; DB.save('employees', l); window.navigateTo('employees'); }
        });
      };

      window.openCheckoutModal = (id) => {
        const s = DB.get('services').find(x => String(x.id) === String(id));
        const valNum = Number(s.value) || 0;
        const b = document.getElementById('modal-box');
        const m = document.getElementById('modal-container');
        m.classList.remove('hidden'); m.classList.add('flex');
        b.innerHTML = `
          <div class="p-8 bg-slate-50 border-b flex justify-between items-center"><h3 class="font-black text-xs uppercase tracking-widest">Finalizar Pagamento</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
          <form id="f-checkout" data-id="${id}" class="p-8 space-y-5">
            <div class="p-8 bg-blue-600 text-white rounded-[2rem] text-center shadow-xl shadow-blue-100">
              <p class="text-[10px] font-black uppercase opacity-60">Valor do Servi√ßo</p>
              <h2 class="text-5xl font-black mt-2">R$ ${valNum.toFixed(2)}</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-[10px] font-black uppercase text-slate-400 mb-2 block">Forma de Pagamento</label>
                <select name="method" required class="input-premium">
                  <option value="PIX">PIX</option>
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
                  <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
                  <option value="Boleto">Boleto</option>
                  <option value="Conv√™nio">Conv√™nio</option>
                </select>
              </div>
              <div>
                <label class="text-[10px] font-black uppercase text-slate-400 mb-2 block">Prazo (Dias)</label>
                <select name="term" required class="input-premium">
                  <option value="√Ä Vista">√Ä Vista</option>
                  <option value="10 dias">10 dias</option>
                  <option value="15 dias">15 dias</option>
                  <option value="20 dias">20 dias</option>
                  <option value="30 dias">30 dias</option>
                </select>
              </div>
            </div>

            <div>
              <label class="text-[10px] font-black uppercase text-slate-400 mb-2 block">Observa√ß√µes / Notas</label>
              <textarea name="obs" placeholder="Anota√ß√µes para a nota ou controle..." class="input-premium h-24 resize-none"></textarea>
            </div>

            <button type="submit" class="w-full py-6 btn-action btn-green uppercase text-xs tracking-widest shadow-2xl">Confirmar Pagamento Realizado</button>
          </form>
        `;
        lucide.createIcons();
      };

      window.openModal = (type, param) => {
        const b = document.getElementById('modal-box');
        const m = document.getElementById('modal-container');
        m.classList.remove('hidden'); m.classList.add('flex');
        b.innerHTML = '';

        if(type === 'customer') {
          b.innerHTML = `
            <div class="p-8 bg-slate-50 border-b flex justify-between"><h3 class="font-black text-xs uppercase">Cadastro de Cliente</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
            <form id="f-customer" class="p-8 space-y-4">
              <input name="name" required placeholder="Nome Completo" class="input-premium">
              <input name="cpf" required placeholder="CPF para NFe" class="input-premium">
              <input name="phone" required placeholder="WhatsApp (DDD + N√∫mero)" class="input-premium">
              <div class="pt-4 border-t"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Endere√ßo (NFe Rio Verde)</p></div>
              <input name="cep" required placeholder="CEP" onblur="fetchAddress(this.value)" class="input-premium">
              <div class="grid grid-cols-2 gap-4">
                <input name="address" required placeholder="Rua" class="input-premium">
                <input name="neighborhood" required placeholder="Bairro" class="input-premium">
              </div>
              <input name="city" required placeholder="Cidade - UF" value="Rio Verde - GO" class="input-premium">
              <div class="grid grid-cols-2 gap-4"><input name="model" placeholder="Ve√≠culo" class="input-premium uppercase"><input name="plate" placeholder="Placa" class="input-premium uppercase"></div>
              <button type="submit" class="w-full py-6 btn-action btn-blue uppercase text-xs">Cadastrar</button>
            </form>
          `;
        } else if(type === 'service') {
          const c = DB.get('customers');
          b.innerHTML = `
            <div class="p-8 bg-slate-50 border-b flex justify-between"><h3 class="font-black text-xs uppercase">Novo Carro no P√°tio</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
            <form id="f-service" class="p-8 space-y-4">
              <select name="customerId" required class="input-premium">
                <option value="">Selecione o Cliente</option>
                ${c.map(x => `<option value="${x.id}">${x.name.toUpperCase()} (${x.plate})</option>`).join('')}
              </select>
              <input name="type" required placeholder="O que ser√° feito?" class="input-premium">
              <input name="value" type="number" step="0.01" required placeholder="Valor R$" class="input-premium">
              <button type="submit" class="w-full py-6 btn-action btn-blue uppercase text-xs">Dar Entrada</button>
            </form>
          `;
        } else if(type === 'expense') {
          b.innerHTML = `
            <div class="p-8 bg-slate-50 border-b flex justify-between"><h3 class="font-black text-xs uppercase tracking-widest">Nova Despesa</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
            <form id="f-expense" class="p-8 space-y-4">
              <select name="category" required class="input-premium">
                <option value="Produtos">Produtos (shampoo, pretinho)</option>
                <option value="Luz">Energia El√©trica</option>
                <option value="√Ågua">√Ågua Saneago</option>
                <option value="Aluguel">Aluguel</option>
                <option value="Manuten√ß√£o/EPI">Manuten√ß√£o / EPI</option>
              </select>
              <input name="description" required placeholder="Descri√ß√£o detalhada" class="input-premium">
              <input name="value" type="number" step="0.01" required placeholder="Valor R$" class="input-premium">
              <button type="submit" class="w-full py-6 btn-action btn-red uppercase text-xs">Lan√ßar Gasto</button>
            </form>
          `;
        } else if(type === 'employee') {
          b.innerHTML = `
            <div class="p-8 bg-slate-50 border-b flex justify-between"><h3 class="font-black text-xs uppercase">Novo Funcion√°rio</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
            <form id="f-employee" class="p-8 space-y-4">
              <input name="name" required placeholder="Nome Completo" class="input-premium">
              <input name="salary" type="number" step="0.01" required placeholder="Sal√°rio Base R$" class="input-premium">
              <button type="submit" class="w-full py-6 btn-action btn-blue uppercase text-xs">Salvar</button>
            </form>
          `;
        } else if(type === 'add_debt') {
          b.innerHTML = `
            <div class="p-8 bg-slate-50 border-b flex justify-between"><h3 class="font-black text-xs uppercase">Lan√ßar D√©bito / Vale</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
            <form id="f-debt" data-id="${param}" class="p-8 space-y-4">
              <select name="type" class="input-premium">
                <option value="advance">Vale / Adiantamento</option>
                <option value="consumption">Consuma√ß√£o</option>
              </select>
              <input name="value" type="number" step="0.01" required placeholder="Valor R$" class="input-premium">
              <button type="submit" class="w-full py-6 btn-action btn-blue uppercase text-xs tracking-widest">Confirmar</button>
            </form>
          `;
        } else if(type === 'edit_service') {
          const s = DB.get('services').find(x => String(x.id) === String(param));
          b.innerHTML = `
            <div class="p-8 bg-slate-50 border-b flex justify-between"><h3 class="font-black text-xs uppercase">Editar Lan√ßamento</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
            <form id="f-edit-service" data-id="${param}" class="p-8 space-y-4">
              <input name="car" required placeholder="Ve√≠culo" value="${s.car || ''}" class="input-premium uppercase">
              <input name="plate" required placeholder="Placa" value="${s.plate || ''}" class="input-premium uppercase">
              <input name="value" type="number" step="0.01" required placeholder="Valor R$" value="${s.value || 0}" class="input-premium">
              <div class="grid grid-cols-2 gap-4">
                <select name="method" class="input-premium">
                  <option value="PIX" ${s.method === 'PIX' ? 'selected' : ''}>PIX</option>
                  <option value="Dinheiro" ${s.method === 'Dinheiro' ? 'selected' : ''}>Dinheiro</option>
                  <option value="Cart√£o D√©bito" ${s.method === 'Cart√£o D√©bito' ? 'selected' : ''}>Cart√£o D√©bito</option>
                  <option value="Cart√£o Cr√©dito" ${s.method === 'Cart√£o Cr√©dito' ? 'selected' : ''}>Cart√£o Cr√©dito</option>
                  <option value="Boleto" ${s.method === 'Boleto' ? 'selected' : ''}>Boleto</option>
                  <option value="Conv√™nio" ${s.method === 'Conv√™nio' ? 'selected' : ''}>Conv√™nio</option>
                </select>
                <select name="term" class="input-premium">
                  <option value="√Ä Vista" ${s.term === '√Ä Vista' ? 'selected' : ''}>√Ä Vista</option>
                  <option value="10 dias" ${s.term === '10 dias' ? 'selected' : ''}>10 dias</option>
                  <option value="15 dias" ${s.term === '15 dias' ? 'selected' : ''}>15 dias</option>
                  <option value="20 dias" ${s.term === '20 dias' ? 'selected' : ''}>20 dias</option>
                  <option value="30 dias" ${s.term === '30 dias' ? 'selected' : ''}>30 dias</option>
                </select>
              </div>
              <textarea name="obs" placeholder="Observa√ß√µes" class="input-premium h-20 resize-none">${s.obs || ''}</textarea>
              <button type="submit" class="w-full py-6 btn-action btn-blue uppercase text-xs">Salvar Altera√ß√µes</button>
            </form>
          `;
        }
        lucide.createIcons();
      };

      document.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        const now = new Date();
        if(e.target.id === 'f-customer') {
          const l = DB.get('customers');
          l.push({ id: Date.now(), ...data });
          DB.save('customers', l); window.navigateTo('customers');
        } else if(e.target.id === 'f-service') {
          const l = DB.get('services');
          const c = DB.get('customers').find(x => String(x.id) === String(data.customerId));
          l.push({ 
            id: Date.now(), ...data, 
            value: parseFloat(data.value) || 0,
            car: c.model, plate: c.plate, customerCpf: c.cpf, customerId: c.id, phone: c.phone,
            customerAddress: `${c.address}, ${c.neighborhood}, ${c.city || 'Rio Verde-GO'}, CEP: ${c.cep}`,
            status: 'Aguardando', paid: false, entryDate: now.toLocaleDateString('pt-BR'), entryTime: now.toLocaleTimeString('pt-BR')
          });
          DB.save('services', l); window.navigateTo('patio');
        } else if(e.target.id === 'f-checkout') {
          const id = e.target.getAttribute('data-id');
          const l = DB.get('services');
          const i = l.findIndex(x => String(x.id) === String(id));
          const isLater = data.method === 'Conv√™nio' || data.method === 'Boleto' || data.term !== '√Ä Vista';
          l[i] = { ...l[i], ...data, paid: true, status: 'Entregue', received: !isLater };
          DB.save('services', l); window.navigateTo('dashboard');
        } else if(e.target.id === 'f-edit-service') {
          const id = e.target.getAttribute('data-id');
          const l = DB.get('services');
          const i = l.findIndex(x => String(x.id) === String(id));
          l[i] = { ...l[i], ...data, value: parseFloat(data.value) || 0 };
          DB.save('services', l); window.navigateTo('financial');
        } else if(e.target.id === 'f-expense') {
          const l = DB.get('expenses');
          l.push({ id: Date.now(), ...data, value: parseFloat(data.value) || 0, date: now.toLocaleDateString('pt-BR') });
          DB.save('expenses', l); window.navigateTo('financial');
        } else if(e.target.id === 'f-employee') {
          const l = DB.get('employees');
          l.push({ id: Date.now(), name: data.name, salary: parseFloat(data.salary) || 0, advances: 0, consumption: 0 });
          DB.save('employees', l); window.navigateTo('employees');
        } else if(e.target.id === 'f-debt') {
          const id = e.target.getAttribute('data-id');
          const l = DB.get('employees');
          const i = l.findIndex(x => String(x.id) === String(id));
          if(data.type === 'advance') l[i].advances += parseFloat(data.value) || 0;
          else l[i].consumption += parseFloat(data.value) || 0;
          DB.save('employees', l); window.navigateTo('employees');
        }
        window.closeModal();
      });

      document.addEventListener('DOMContentLoaded', () => { window.navigateTo('dashboard'); });
    </script>
  </body>
</html>
